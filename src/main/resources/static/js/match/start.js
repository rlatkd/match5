$('.owl-carousel-day').owlCarousel({
    loop: false,
    margin: 0,
    nav: true,
    navText: [
        '<svg fill="#a6a6a6" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#a6a6a6" transform="matrix(-1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M256,0C114.837,0,0,114.837,0,256s114.837,256,256,256s256-114.837,256-256S397.163,0,256,0z M335.083,271.083 L228.416,377.749c-4.16,4.16-9.621,6.251-15.083,6.251c-5.461,0-10.923-2.091-15.083-6.251c-8.341-8.341-8.341-21.824,0-30.165 L289.835,256l-91.584-91.584c-8.341-8.341-8.341-21.824,0-30.165s21.824-8.341,30.165,0l106.667,106.667 C343.424,249.259,343.424,262.741,335.083,271.083z"></path> </g> </g> </g></svg>',
        '<svg fill="#a6a6a6" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#a6a6a6" transform="matrix(1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M256,0C114.837,0,0,114.837,0,256s114.837,256,256,256s256-114.837,256-256S397.163,0,256,0z M335.083,271.083 L228.416,377.749c-4.16,4.16-9.621,6.251-15.083,6.251c-5.461,0-10.923-2.091-15.083-6.251c-8.341-8.341-8.341-21.824,0-30.165 L289.835,256l-91.584-91.584c-8.341-8.341-8.341-21.824,0-30.165s21.824-8.341,30.165,0l106.667,106.667 C343.424,249.259,343.424,262.741,335.083,271.083z"></path> </g> </g> </g></svg>'
    ],
    autoplay: false,
    autoplayHoverPause: false,
    responsive: {
        0: {
            items: 1
        },
        500: {
            items: 2
        },
        800: {
            items: 3
        },
        1000: {
            items: 4
        },
        1200: {
            items: 5
        }
    }
})

$('.owl-carousel-time').owlCarousel({
    loop: false,
    margin: 20,
    nav: true,
    navText: [
        '<svg fill="#a6a6a6" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#a6a6a6" transform="matrix(-1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M256,0C114.837,0,0,114.837,0,256s114.837,256,256,256s256-114.837,256-256S397.163,0,256,0z M335.083,271.083 L228.416,377.749c-4.16,4.16-9.621,6.251-15.083,6.251c-5.461,0-10.923-2.091-15.083-6.251c-8.341-8.341-8.341-21.824,0-30.165 L289.835,256l-91.584-91.584c-8.341-8.341-8.341-21.824,0-30.165s21.824-8.341,30.165,0l106.667,106.667 C343.424,249.259,343.424,262.741,335.083,271.083z"></path> </g> </g> </g></svg>',
        '<svg fill="#a6a6a6" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#a6a6a6" transform="matrix(1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M256,0C114.837,0,0,114.837,0,256s114.837,256,256,256s256-114.837,256-256S397.163,0,256,0z M335.083,271.083 L228.416,377.749c-4.16,4.16-9.621,6.251-15.083,6.251c-5.461,0-10.923-2.091-15.083-6.251c-8.341-8.341-8.341-21.824,0-30.165 L289.835,256l-91.584-91.584c-8.341-8.341-8.341-21.824,0-30.165s21.824-8.341,30.165,0l106.667,106.667 C343.424,249.259,343.424,262.741,335.083,271.083z"></path> </g> </g> </g></svg>'
    ],
    autoplay: false,
    autoplayHoverPause: false,
    responsive: {
        0: {
            items: 1
        },
        600: {
            items: 3
        },
        1000: {
            items: 6
        }
    }
})

$('.owl-carousel-loc').owlCarousel({
    loop: false,
    margin: 20,
    nav: true,
    navText: [
        '<svg fill="#a6a6a6" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#a6a6a6" transform="matrix(-1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M256,0C114.837,0,0,114.837,0,256s114.837,256,256,256s256-114.837,256-256S397.163,0,256,0z M335.083,271.083 L228.416,377.749c-4.16,4.16-9.621,6.251-15.083,6.251c-5.461,0-10.923-2.091-15.083-6.251c-8.341-8.341-8.341-21.824,0-30.165 L289.835,256l-91.584-91.584c-8.341-8.341-8.341-21.824,0-30.165s21.824-8.341,30.165,0l106.667,106.667 C343.424,249.259,343.424,262.741,335.083,271.083z"></path> </g> </g> </g></svg>',
        '<svg fill="#a6a6a6" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#a6a6a6" transform="matrix(1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M256,0C114.837,0,0,114.837,0,256s114.837,256,256,256s256-114.837,256-256S397.163,0,256,0z M335.083,271.083 L228.416,377.749c-4.16,4.16-9.621,6.251-15.083,6.251c-5.461,0-10.923-2.091-15.083-6.251c-8.341-8.341-8.341-21.824,0-30.165 L289.835,256l-91.584-91.584c-8.341-8.341-8.341-21.824,0-30.165s21.824-8.341,30.165,0l106.667,106.667 C343.424,249.259,343.424,262.741,335.083,271.083z"></path> </g> </g> </g></svg>'
    ],
    autoplay: false,
    autoplayHoverPause: false,
    responsive: {
        0: {
            items: 1
        },
        600: {
            items: 3
        },
        1000: {
            items: 6
        }
    }
})

//여기부터 API 로직
let weatherData;
let data = {
    userId: null,
    selectedDate: null,
    selectedTime: null,
    location: null,
    isManager: null,
    isOutdoor: null

};

const getClientId = async () => {
    const clientInfoData = await fetch("/api/auth/kakao/ids");
    clientInfo = await clientInfoData.json();
    data.userId = clientInfo.userId
}

getClientId();

let code;

// 기상 ------------------------------------------------
const getWeatherData = async () => {
    const userRawData = await fetch(`/api/weather`);
    weatherData = await userRawData.json();
    console.log("weatherData.status:", weatherData.status);

    code = weatherData.status //기상정보 못 받아올때 status code로 화면 예외로직 구현
}

const loadStart = async () => {
    await getWeatherData();
    const $$owlCarouselDay = document.querySelectorAll('.owl-carousel-day .item');
    let currentDate = new Date();
    let tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate()+1);

    // $$owlCarouselDay.forEach(($item, index) => {
    //     const minTemp = null;
    //     const maxTemp = null;
    //     const temp = null;
    //
    //     const date = dateFormattor(tomorrowDate, index);
    //
    //     const $$leftContent = $item.querySelectorAll('.weather-label-left-container p');
    //     $$leftContent[0].textContent  = date;
    //     $$leftContent[1].innerHTML = temp;
    //     $$leftContent[2].textContent = null;
    //
    //     const $rightContent = $item.querySelector('.weather-label-right-container img');
    //     $rightContent.src = null;
    // })



    if (code == 500) {

        $$owlCarouselDay.forEach(($item, index) => {
            const minTemp = null;
            const maxTemp = null;
            const temp = null;

            const date = dateFormattor(tomorrowDate, index);

            const $$leftContent = $item.querySelectorAll('.weather-label-left-container p');
            $$leftContent[0].textContent  = date;
            $$leftContent[1].innerHTML = temp;
            $$leftContent[2].textContent = null;

            const $rightContent = $item.querySelector('.weather-label-right-container img');
            $rightContent.src = null;
        })




    } else {
        $$owlCarouselDay.forEach(($item, index) => {
            const minTemp = Math.round(parseFloat(weatherData[index].minTemp));
            const maxTemp = Math.round(parseFloat(weatherData[index].maxTemp));
            const temp = `${minTemp}&#8451; | ${maxTemp}&#8451;`;

            const date = dateFormattor(tomorrowDate, index);

            const $$leftContent = $item.querySelectorAll('.weather-label-left-container p');
            $$leftContent[0].textContent  = date;
            $$leftContent[1].innerHTML = temp;
            $$leftContent[2].textContent = weatherData[index].weather;

            const $rightContent = $item.querySelector('.weather-label-right-container img');
            $rightContent.src = weatherData[index].weatherIcon;
        })
    }
}

// 날짜 구하기
const dateFormattor = (currentDate, i) => {
    let futureDate = new Date();
    futureDate.setDate(currentDate.getDate() + i);

    let month = (futureDate.getMonth() + 1).toString().padStart(2, '0');
    let day = futureDate.getDate().toString().padStart(2, '0');
    let dayOfWeek = futureDate.getDay();
    let weekdays = ["일", "월", "화", "수", "목", "금", "토"];
    let dayOfWeekString = weekdays[dayOfWeek];

    // 날짜와 요일 조합하여 문자 만들어 배열에 추가
    let formattedFutureDate = `${month}/${day} ${dayOfWeekString}`;
    return formattedFutureDate;
}

// 기상 데이터 가져오기
loadStart();


// 모달------------------------------------------------
const modalData = [
    {
        dialogName: '.info-confirm-dialog',
        openName: 'button.info-confirm-Open',
        closeName: 'button.info-confirm-Close'
    },
    {
        dialogName: '.info-error-dialog',
        openName: 'button.info-error-Open',
        closeName: 'button.info-error-Close'
    }
]

const modalHandler = () => {
    modalData.forEach(item => {
        const dialogName = item.dialogName;
        const openName = item.openName;
        const closeName = item.closeName;

        const infoDialog = document.querySelector(dialogName)
        infoDialog.addEventListener('click', (event) => {
            if (event.target.nodeName === 'DIALOG') {
                infoDialog.close()
            }
        })

        const openInfoModalButton = document.querySelector(openName)
        if (openInfoModalButton != null) {
            openInfoModalButton.addEventListener('click', () => {
                infoDialog.showModal()
            })
        }

        const closeInfoModalButton = document.querySelector(closeName)
        if (closeInfoModalButton != null) {
            closeInfoModalButton.addEventListener('click', () => {
                infoDialog.close()
            })
        }
    });
}

modalHandler();
// 모달 끝------------------------------------------------



// 버튼
$startButton = document.querySelector('.startform__submit-container button')
$startButton.addEventListener('click', () => {
    let hasNullValue = Object.values(data).includes(null); // 클릭할 때마다 null 값 확인
    if (!hasNullValue) {
        updateConditionContent();
        document.querySelector('.info-confirm-dialog').showModal();


// "확인" 버튼에 클릭 이벤트 추가
        const confirmButton = document.querySelector('.info-confirm-dialog button:last-child');
        confirmButton.addEventListener('click', async () => {
            console.log("[data0000]", data)
            console.log("[userId]",typeof(data.userId))
            console.log("[selectedDate]",typeof(data.selectedDate))
            console.log("[selectedTime]",typeof(data.selectedTime))
            console.log("[location]",typeof(data.location))
            console.log("[isOutdoor]",typeof(data.isOutdoor))
            console.log("[isManager]",typeof(data.isManager))

            await startMatching(); // startMatching 함수 호출
            // setTimeout(() => window.location.href = '/', 500); // 페이지 리다이렉트
        });

    } else {
        console.log("[data]", data)
        console.log("[value(data)]", Object.values(data));
        console.log("hasnull",hasNullValue);

        document.querySelector('.info-error-dialog').showModal();
    }
})



//날짜 format 변경
const formatDate = (date) => {
    let year = date.getFullYear();
    let month = String(date.getMonth() + 1).padStart(2, '0');
    let day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 날짜 선택
document.getElementById('day-1').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 1);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

document.getElementById('day-2').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 2);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

document.getElementById('day-3').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 3);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

document.getElementById('day-4').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 4);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

document.getElementById('day-5').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 5);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

document.getElementById('day-6').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 6);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

document.getElementById('day-7').addEventListener('change', () => {
    const currentDate = new Date();
    const tomorrowDate = new Date(currentDate);
    tomorrowDate.setDate(currentDate.getDate() + 7);
    data.selectedDate = formatDate(tomorrowDate);
    console.log("data - ", data);
    console.log("data.selectedDate - ", data.selectedDate);
});

//시간 선택
document.querySelectorAll('input[name="slot"]').forEach(input => {
    input.addEventListener('change', () => {
        // 시간대 문자열 추출
        const timeString = document.querySelector(`label[for="${input.id}"]`).innerText;

        // 시간대 문자열을 '-' 기준으로 분할하여 각각의 시작 시간과 종료 시간 추출
        const [startTime, endTime] = timeString.split(' - ');

        // 각 시간대의 시각 문자열에서 시간 부분만 추출하여 정수로 변환 후 중간값 계산
        const startHour = parseInt(startTime.split(':')[0]);
        const endHour = parseInt(endTime.split(':')[0]);
        const middleHour = Math.floor((startHour + endHour) / 2);

        // 중간값을 문자열로 변환하여 할당
        data.selectedTime = middleHour;

        console.log("data - ", data);
        console.log("data.time - ", data.selectedTime);
    });
});

//지역 선택
document.querySelectorAll('input[name="location"]').forEach(input => {
    input.addEventListener('change', () => {
        data.location = document.querySelector(`label[for="${input.id}"]`).innerText;
        console.log("data - ", data);
        console.log("data.location - ", data.location);
    });
});

//추가 조건 선택 - 실내외 여부
document.querySelectorAll('input[name="indooronnot"]').forEach(input => {
    input.addEventListener('change', () => {
        data.isOutdoor = parseInt(input.value);
        console.log("data - ", data);
        console.log("data.isOutdoor - ", data.isOutdoor);
    });
});

//추가 조건 선택 - 매니저 여부
document.querySelectorAll('input[name="managerselect"]').forEach(input => {
    input.addEventListener('change', () => {
        console.log("[확인할거]", input.value);
        console.log("[확인할거]", typeof(input.value))
        data.isManager = parseInt(input.value);
        console.log("data - ", data);
        console.log("data.isManager - ", data.isManager);
    });
});




const startMatching = async () => {
    try {
        const res = await fetch('/api/matchQ', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        console.log("", res)

        const msg = await res.text();
        console.log("응답메시지 - ", msg);
        window.location.href = "/";
    } catch (err) {
        console.log(err);
    }
};

//최종 모달을 위한 문자열 포멧
const conditionContainer = document.querySelector('.dialogo-content-select-codition');

const formatTime = (selectedTime) => {
    const startTime = ("0" + (selectedTime-1) + ":00").slice(-5);
    const endTime = ("0" + (selectedTime+1) + ":00").slice(-5);
    return `${startTime} ~ ${endTime}`;
};

const getIndoorOutdoorText = (isOutdoor) => {
    if (isOutdoor === 0) {
        return '실내';
    } else if (isOutdoor === 1) {
        return '실외';
    } else {
        return '미선택';
    }
};

const getManagerText = (isManager) => {
    if (isManager === 0) {
        return '매니저 불가능';
    } else {
        return '매니저 가능';
    }
};

const updateConditionContent = () => {
    const dateParts = data.selectedDate.split('-');
    const selectedDateText = `${dateParts[0]}년 ${parseInt(dateParts[1])}월 ${parseInt(dateParts[2])}일`;

    const selectedTimeText = formatTime(data.selectedTime);
    const locationText = data.location;
    const indoorOutdoorText = getIndoorOutdoorText(data.isOutdoor);
    const managerText = getManagerText(data.isManager);

    conditionContainer.innerHTML = `
        <p>${selectedDateText}</p>
        <p>${selectedTimeText}</p>
        <p>${locationText}</p>
        <p>${indoorOutdoorText}</p>
        <p>${managerText}</p>
    `;
};